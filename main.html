<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng Ký Thông Tin Áo - Nhập liệu từ Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện XLSX để xử lý file Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .tab-button.active {
        border-bottom: 2px solid #3b82f6;
        color: #3b82f6;
      }
      .select2-container--default .select2-selection--single {
        border-radius: 0.375rem;
        border-color: #d1d5db;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.5rem;
        height: auto !important;
      }
      .select2-container--default
        .select2-selection--single
        .select2-selection__arrow {
        top: 50%;
        transform: translateY(-50%);
      }
      .select2-container--default
        .select2-selection--single
        .select2-selection__rendered {
        padding-right: 2rem;
        line-height: normal;
      }
      .select2-results__option--highlighted[aria-selected] {
        background-color: #2563eb !important;
        color: white !important;
      }
      .select2-results__option[aria-selected="true"] {
        background-color: #dbeafe !important;
      }
      .select2-dropdown {
        border-radius: 0.375rem;
        border-color: #d1d5db;
      }
      /* Style cho input bị disabled */
      .disabled-input {
        background-color: #e5e7eb;
        cursor: not-allowed;
      }
      /* Style cho nút filter */
      .filter-button {
        transition: all 0.15s ease-in-out;
      }
      .filter-button.active {
        background-color: #10b981; /* green-500 */
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8"
  >
    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"
      ></div>
    </div>

    <!-- Toast Message -->
    <div
      id="toast-message"
      class="fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden transition-opacity duration-300 ease-in-out"
    >
      Thông tin đã được lưu thành công!
    </div>

    <!-- Main App Container -->
    <div
      id="app-container"
      class="max-w-4xl w-full bg-white rounded-xl shadow-2xl overflow-hidden"
    >
      <div class="p-6 sm:p-8">
        <h1
          class="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 mb-6"
        >
          Đăng Ký Thông Tin Áo
        </h1>

        <div class="flex justify-center mb-6 border-b border-gray-200">
          <button
            id="input-tab"
            class="tab-button active flex-1 py-3 px-4 text-center text-sm sm:text-base font-medium text-gray-500 hover:text-blue-500 transition duration-150 ease-in-out"
          >
            Nhập Thông Tin Cá Nhân
          </button>
          <button
            id="view-tab"
            class="tab-button flex-1 py-3 px-4 text-center text-sm sm:text-base font-medium text-gray-500 hover:text-blue-500 transition duration-150 ease-in-out"
          >
            Xem & Quản Lý Dữ Liệu
          </button>
        </div>

        <!-- Nhập liệu -->
        <div id="tab-content-input" class="tab-content space-y-6">
          <p class="text-center text-gray-600">
            Chọn tên của bạn và điền các thông tin cần thiết.
          </p>
          <div
            id="excel-warning"
            class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"
            role="alert"
          >
            <strong class="font-bold">Lưu ý: </strong>
            <span class="block sm:inline"
              >Vui lòng tải lên File Excel trước để có danh sách tên.</span
            >
          </div>
          <form id="info-form" class="space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label
                  for="full-name"
                  class="block text-sm font-medium text-gray-700"
                  >Họ và tên</label
                >
                <select
                  id="full-name"
                  name="full-name"
                  required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                >
                  <option value="" disabled selected>Chọn tên của bạn</option>
                </select>
              </div>
              <div>
                <label
                  for="shirt-number"
                  class="block text-sm font-medium text-gray-700"
                  >Số áo</label
                >
                <input
                  type="text"
                  id="shirt-number"
                  name="shirt-number"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                  placeholder="Nhập số áo"
                  pattern="[0-9]*"
                  inputmode="numeric"
                  title="Vui lòng chỉ nhập số."
                />
              </div>
            </div>
            <!-- CỘT TÊN ÁO & SIZE -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label
                  for="shirt-name"
                  class="block text-sm font-medium text-gray-700"
                  >Tên áo</label
                >
                <input
                  type="text"
                  id="shirt-name"
                  name="shirt-name"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                  placeholder="Nhập tên in trên áo"
                />
              </div>
              <div>
                <label
                  for="shirt-size"
                  class="block text-sm font-medium text-gray-700"
                  >Size áo</label
                >
                <select
                  id="shirt-size"
                  name="shirt-size"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                >
                  <option value="" disabled selected>Chọn size áo</option>
                  <option value="S">S</option>
                  <option value="M">M</option>
                  <option value="L">L</option>
                  <option value="XL">XL</option>
                  <option value="2XL">2XL</option>
                  <option value="3XL">3XL</option>
                </select>
              </div>
            </div>

            <div class="flex items-center">
              <input
                id="no-need-shirt"
                name="no-need-shirt"
                type="checkbox"
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label
                for="no-need-shirt"
                class="ml-2 block text-sm text-gray-900"
                >Không cần đặt áo</label
              >
            </div>

            <!-- ĐÃ BỎ PHẦN UPLOAD HÌNH ẢNH -->

            <div class="flex justify-end space-x-4">
              <button
                type="button"
                id="edit-button"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden"
              >
                Cập nhật thông tin
              </button>
              <button
                type="submit"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Lưu thông tin
              </button>
            </div>
          </form>
        </div>

        <!-- Xem Dữ Liệu -->
        <div id="tab-content-view" class="tab-content hidden">
          <div
            class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-3 sm:space-y-0"
          >
            <h3 class="text-lg font-bold text-gray-900">Bảng Dữ Liệu</h3>
            <div class="space-x-2 flex flex-wrap justify-end">
              <label
                for="excel-file"
                class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 cursor-pointer"
              >
                Tải lên File Nguồn Excel (Cập nhật danh sách)
                <input
                  type="file"
                  id="excel-file"
                  name="excel-file"
                  accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                  class="hidden"
                />
              </label>
              <button
                id="download-excel"
                class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
              >
                Tải xuống Excel (Dữ liệu đã đăng ký)
              </button>
            </div>
          </div>

          <!-- BỘ LỌC DỮ LIỆU MỚI -->
          <div class="flex justify-start mb-4 space-x-3">
            <p class="text-sm font-medium text-gray-700 mr-2 self-center">
              Chế độ xem:
            </p>
            <button
              id="filter-all"
              class="filter-button active py-1 px-3 text-xs font-semibold rounded-full bg-gray-200 hover:bg-gray-300"
              data-filter="all"
            >
              Tất cả
            </button>
            <button
              id="filter-registered"
              class="filter-button py-1 px-3 text-xs font-semibold rounded-full bg-gray-200 hover:bg-gray-300"
              data-filter="registered"
            >
              Đã Đặt
            </button>
            <button
              id="filter-unregistered"
              class="filter-button py-1 px-3 text-xs font-semibold rounded-full bg-gray-200 hover:bg-gray-300"
              data-filter="unregistered"
            >
              Không Đặt
            </button>
          </div>
          <!-- END BỘ LỌC DỮ LIỆU MỚI -->

          <p class="text-sm text-gray-500 mb-4">
            Dữ liệu trong bảng là sự kết hợp giữa danh sách tên từ file Excel
            nguồn (cột Họ và tên) và thông tin đăng ký (Số áo, Tên áo, Size áo)
            đã được lưu vào hệ thống.
          </p>
          <div class="overflow-x-auto rounded-lg shadow-lg">
            <table id="data-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    STT
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Họ và tên
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Số áo
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Tên áo
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Size áo
                  </th>
                  <!-- ĐÃ BỎ CỘT HÌNH ẢNH -->
                </tr>
              </thead>
              <tbody
                id="data-table-body"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Dữ liệu sẽ được chèn vào đây -->
                >
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal cho thông báo trùng số áo -->
    <div
      id="duplicate-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-80 shadow-xl text-center">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Số áo đã tồn tại</h3>
        <p class="text-sm text-gray-600 mb-6">
          Số áo này đã có người đăng ký. Bạn có muốn tiếp tục?
        </p>
        <div class="flex justify-around">
          <button
            id="modal-cancel"
            class="py-2 px-4 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150 ease-in-out"
          >
            Hủy
          </button>
          <button
            id="modal-confirm"
            class="py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out"
          >
            Xác nhận
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getDatabase, // Lấy đối tượng Realtime Database
        ref, // Tạo tham chiếu đến đường dẫn
        set, // Hàm set để ghi/ghi đè dữ liệu
        update, // Hàm update để cập nhật một phần dữ liệu
        onValue, // Hàm lắng nghe sự kiện thay đổi dữ liệu (Realtime)
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

      // Firebase configuration and initialization (Sử dụng config có sẵn)
      let app, db, auth;
      let userId;
      let usersData = {}; // Dữ liệu đã đăng ký từ RTDB (key là tên đã được mã hóa)
      let initialData = []; // Danh sách tên được tải từ file Excel nguồn (Bây giờ được đồng bộ với DB)
      let authReady = false;
      let currentFilter = "all"; // Biến mới để lưu trạng thái filter

      const loader = document.getElementById("loading-overlay");
      const fullNameSelect = document.getElementById("full-name");
      const shirtNumberInput = document.getElementById("shirt-number");
      const shirtNameInput = document.getElementById("shirt-name");
      const shirtSizeSelect = document.getElementById("shirt-size");
      const noNeedShirtCheckbox = document.getElementById("no-need-shirt");
      const form = document.getElementById("info-form");
      const editButton = document.getElementById("edit-button");
      const submitButton = form.querySelector('[type="submit"]');
      const dataTableBody = document.getElementById("data-table-body");
      const inputTab = document.getElementById("input-tab");
      const viewTab = document.getElementById("view-tab");
      const inputTabContent = document.getElementById("tab-content-input");
      const viewTabContent = document.getElementById("tab-content-view");
      const duplicateModal = document.getElementById("duplicate-modal");
      const modalConfirm = document.getElementById("modal-confirm");
      const modalCancel = document.getElementById("modal-cancel");
      const toastMessage = document.getElementById("toast-message");
      const excelFileInput = document.getElementById("excel-file");
      const downloadExcelBtn = document.getElementById("download-excel");
      const excelWarning = document.getElementById("excel-warning");

      // ELEMENTS BỘ LỌC MỚI
      const filterButtons = document.querySelectorAll(".filter-button");

      loader.style.display = "flex";

      // HÀM MỚI: Cập nhật trạng thái disabled/enabled cho các trường
      function setShirtDetailsDisabled(disabled) {
        // Danh sách các trường liên quan đến áo
        const shirtFields = [shirtNumberInput, shirtNameInput, shirtSizeSelect];

        shirtFields.forEach((field) => {
          field.disabled = disabled;
          if (disabled) {
            field.classList.add("disabled-input");
          } else {
            field.classList.remove("disabled-input");
          }
          // Nếu disabled, xóa giá trị để tránh lưu giá trị cũ
          if (disabled) {
            field.value = "";
          }
        });
        // Đối với Select2, cần làm thêm bước này để vô hiệu hóa
        // $(shirtSizeSelect).select2(disabled ? "disable" : "enable");
      }

      function showToast(message, isError = false) {
        toastMessage.textContent = message;
        if (isError) {
          toastMessage.classList.remove("bg-green-500");
          toastMessage.classList.add("bg-red-500");
        } else {
          toastMessage.classList.remove("bg-red-500");
          toastMessage.classList.add("bg-green-500");
        }
        toastMessage.classList.remove("hidden");
        toastMessage.classList.add("opacity-100");
        setTimeout(() => {
          toastMessage.classList.remove("opacity-100");
          toastMessage.classList.add("opacity-0");
          setTimeout(() => {
            toastMessage.classList.add("hidden");
            toastMessage.classList.remove("opacity-0");
          }, 300);
        }, 3000);
      }

      async function initializeAppAndAuth() {
        try {
          // Khởi tạo Firebase từ biến toàn cục
          const firebaseConfig = {
            apiKey: "AIzaSyCvC6yMxGShDbe6CFxW_BJr4jWshZ0WFAU",
            authDomain: "webchonao.firebaseapp.com",
            projectId: "webchonao",
            storageBucket: "webchonao.firebasestorage.app",
            messagingSenderId: "1003558568709",
            appId: "1:1003558568709:web:054e30c22b0349dfb56d6c",
            measurementId: "G-F7ZL70RDE9",
          };
          const appId =
            typeof __app_id !== "undefined" ? __app_id : "default-app-id";
          const authToken =
            typeof __initial_auth_token !== "undefined"
              ? __initial_auth_token
              : null;

          if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
              if (user) {
                userId = user.uid;
              } else {
                try {
                  if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                  } else {
                    await signInAnonymously(auth);
                  }
                  userId = auth.currentUser?.uid;
                } catch (error) {
                  console.error("Firebase auth failed:", error);
                }
              }
              authReady = true;
              loader.style.display = "none";
              setupListeners(appId);
              // Cảnh báo Excel sẽ được xử lý trong fetchSourceNames
            });
          } else {
            console.error("Firebase config is empty.");
            loader.style.display = "none";
          }
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          loader.style.display = "none";
        }
      }

      // Hàm cập nhật select box tên (chạy sau khi tải Excel hoặc tải từ DB)
      function updateFullNameSelect() {
        $(fullNameSelect)
          .empty()
          .append(
            '<option value="" disabled selected>Chọn tên của bạn</option>'
          );
        if (initialData.length > 0) {
          initialData.forEach((person) => {
            const option = document.createElement("option");
            option.value = person.name;
            option.textContent = person.name;
            fullNameSelect.appendChild(option);
          });
        }
        $(fullNameSelect).select2();
        updateFormForUser(); // Cập nhật form sau khi tên thay đổi
      }

      // HÀM MỚI: Tải danh sách tên nguồn từ Realtime Database
      function fetchSourceNames(appId) {
        // TẠO PATH CHO RTDB: /artifacts/{appId}/public/data/source_names
        const sourceNamesPath = `/artifacts/${appId}/public/data/source_names`;
        const namesRef = ref(db, sourceNamesPath);

        // Lắng nghe dữ liệu danh sách tên
        onValue(namesRef, (snapshot) => {
          const data = snapshot.val();
          // Dữ liệu được lưu dưới dạng array of objects [{name: "Name A"}, {name: "Name B"}]
          if (data && Array.isArray(data) && data.length > 0) {
            initialData = data;
            excelWarning.classList.add("hidden");
            updateFullNameSelect();
            renderTable();
            console.log("Tải thành công danh sách tên nguồn từ Database.");
          } else {
            // Nếu không có dữ liệu, hiển thị cảnh báo
            initialData = [];
            excelWarning.classList.remove("hidden");
            updateFullNameSelect();
            renderTable();
          }
        });
      }

      function setupListeners(appId) {
        if (!db || !authReady) return;

        // Tải danh sách tên nguồn từ Database (Fix lỗi mất dữ liệu khi reload)
        fetchSourceNames(appId);

        // TẠO PATH CHO RTDB: /artifacts/{appId}/public/data/registrations
        const rtdbPath = `/artifacts/${appId}/public/data/registrations`;
        const usersRef = ref(db, rtdbPath);

        // Lắng nghe dữ liệu đăng ký
        onValue(usersRef, (snapshot) => {
          usersData = snapshot.val() || {}; // usersData là đối tượng { key: data, ... }
          renderTable();
          // Không gọi updateFormForUser ở đây để tránh lỗi khi select2 chưa sẵn sàng
        });

        $(fullNameSelect).on("change", updateFormForUser);

        // Lắng nghe sự kiện thay đổi của checkbox
        noNeedShirtCheckbox.addEventListener("change", () => {
          const disabled = noNeedShirtCheckbox.checked;
          setShirtDetailsDisabled(disabled);
        });

        // HÀM MỚI: Thêm kiểm tra chỉ được nhập số cho Số áo
        shirtNumberInput.addEventListener("input", (event) => {
          // Loại bỏ các ký tự không phải số
          event.target.value = event.target.value.replace(/[^0-9]/g, "");
        });

        form.addEventListener("submit", handleFormSubmit);
        editButton.addEventListener("click", handleFormSubmit);

        excelFileInput.addEventListener("change", handleExcelUpload);
        downloadExcelBtn.addEventListener("click", handleDownloadExcel);

        inputTab.addEventListener("click", () => switchTab("input"));
        viewTab.addEventListener("click", () => switchTab("view"));

        modalConfirm.addEventListener("click", () => {
          duplicateModal.classList.add("hidden");
          submitFormWithDuplicateCheck(true);
        });
        modalCancel.addEventListener("click", () => {
          duplicateModal.classList.add("hidden");
        });

        // LOGIC LẮNG NGHE BỘ LỌC MỚI
        filterButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const newFilter = event.target.getAttribute("data-filter");
            if (newFilter !== currentFilter) {
              currentFilter = newFilter;
              // Cập nhật trạng thái active cho nút
              filterButtons.forEach((btn) =>
                btn.classList.remove("active", "bg-green-500", "text-white")
              );
              event.target.classList.add(
                "active",
                "bg-green-500",
                "text-white"
              );
              renderTable(); // Vẽ lại bảng với filter mới
            }
          });
        });
      }

      function switchTab(tab) {
        if (tab === "input") {
          inputTabContent.classList.remove("hidden");
          viewTabContent.classList.add("hidden");
          inputTab.classList.add("active");
          viewTab.classList.remove("active");
        } else {
          inputTabContent.classList.add("hidden");
          viewTabContent.classList.remove("hidden");
          inputTab.classList.remove("active");
          viewTab.classList.add("active");
          renderTable(); // Đảm bảo bảng được vẽ lại khi chuyển sang tab View
        }
      }

      function renderTable() {
        dataTableBody.innerHTML = "";

        // Dữ liệu hiển thị là danh sách tên nguồn (initialData) + dữ liệu đã đăng ký (usersData)
        let combinedData = [...initialData].map((person) => {
          // Tạo key an toàn cho RTDB
          const safeKey = person.name.replace(/[.#$/[\]]/g, "_");
          const userData = usersData[safeKey];
          const noShirt = userData?.noShirt || false;
          const isRegistered = !!userData;

          return {
            name: person.name,
            shirtNumber: userData?.shirtNumber || "",
            shirtName: userData?.shirtName || "",
            shirtSize: userData?.shirtSize || "",
            noShirt: noShirt,
            isRegistered: isRegistered,
            // BỎ TRƯỜNG imageUrl
          };
        });

        // ------------------ BỘ LỌC DỮ LIỆU MỚI ------------------
        let filteredData = combinedData;

        if (currentFilter === "registered") {
          // Đã Đặt: Người đã đăng ký và KHÔNG chọn "Không đặt áo"
          filteredData = combinedData.filter(
            (person) => person.isRegistered && !person.noShirt
          );
        } else if (currentFilter === "unregistered") {
          // Không Đặt: Người đã đăng ký và chọn "Không đặt áo" HOẶC người chưa đăng ký thông tin áo (chưa có trong usersData)
          // Tuy nhiên, theo yêu cầu là "Đặt" và "Không đặt" (liên quan đến nút check), nên ta lọc theo noShirt
          // Người đã đăng ký và chọn "Không đặt áo"
          filteredData = combinedData.filter((person) => person.noShirt);
          // Hoặc nếu muốn hiển thị cả người chưa đăng ký:
          // filteredData = combinedData.filter(person => person.noShirt || !person.isRegistered);
        }

        // Điều chỉnh lại logic lọc theo yêu cầu:
        // Chế độ "Đặt" (Registered): isRegistered (đã có dữ liệu trong DB) VÀ noShirt là false
        // Chế độ "Không đặt" (Unregistered): noShirt là true

        if (currentFilter === "registered") {
          filteredData = combinedData.filter(
            (person) => person.isRegistered && !person.noShirt
          );
        } else if (currentFilter === "unregistered") {
          filteredData = combinedData.filter((person) => person.noShirt);
        }

        // ------------------ END BỘ LỌC DỮ LIỆU MỚI ------------------

        // Nếu initialData rỗng, chỉ hiển thị những người đã đăng ký (dù về logic mới là không xảy ra)
        if (initialData.length === 0) {
          Object.keys(usersData).forEach((safeKey) => {
            const userData = usersData[safeKey];
            // Chỉ thêm vào nếu tên này chưa có trong initialData (dùng fullName)
            if (!filteredData.some((p) => p.name === userData.fullName)) {
              filteredData.push({
                name: userData.fullName,
                shirtNumber: userData.shirtNumber || "",
                shirtName: userData.shirtName || "",
                shirtSize: userData.shirtSize || "",
                noShirt: userData.noShirt || false,
                isRegistered: true,
              });
            }
          });
        }

        filteredData.forEach((person, index) => {
          const row = document.createElement("tr");
          row.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";

          // Chuẩn hóa hiển thị
          const displayShirtNumber = person.noShirt
            ? "Không đặt"
            : person.shirtNumber || (person.isRegistered ? "" : "Chưa ĐK"); // Hiện trạng thái Chưa ĐK nếu chưa có dữ liệu
          const displayShirtName = person.noShirt ? "" : person.shirtName || "";
          const displayShirtSize = person.noShirt ? "" : person.shirtSize || "";

          row.innerHTML = `
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                            index + 1
                          }</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                            person.name
                          }</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${displayShirtNumber}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${displayShirtName}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${displayShirtSize}</td>
                      `;
          dataTableBody.appendChild(row);
        });
      }

      function updateFormForUser() {
        const selectedName = fullNameSelect.value;
        if (!selectedName) {
          // Reset form nếu chưa chọn tên
          shirtNumberInput.value = "";
          shirtNameInput.value = "";
          shirtSizeSelect.value = "";
          noNeedShirtCheckbox.checked = false;
          editButton.classList.add("hidden");
          submitButton.classList.remove("hidden");
          // Vô hiệu hóa các trường
          setShirtDetailsDisabled(true); // Vô hiệu hóa khi chưa chọn tên
          return;
        }

        const safeKey = selectedName.replace(/[.#$/[\]]/g, "_");
        const userData = usersData[safeKey];

        if (userData) {
          shirtNumberInput.value = userData.shirtNumber || "";
          shirtNameInput.value = userData.shirtName || "";
          shirtSizeSelect.value = userData.shirtSize || "";
          noNeedShirtCheckbox.checked = userData.noShirt || false;

          const disabled = noNeedShirtCheckbox.checked;
          setShirtDetailsDisabled(disabled); // Cập nhật trạng thái disabled

          editButton.classList.remove("hidden");
          submitButton.classList.add("hidden");
        } else {
          // Reset form cho người dùng mới
          shirtNumberInput.value = "";
          shirtNameInput.value = "";
          shirtSizeSelect.value = "";
          noNeedShirtCheckbox.checked = false;
          // Đảm bảo các trường được enabled (vì người dùng chưa đăng ký)
          setShirtDetailsDisabled(false);
          editButton.classList.add("hidden");
          submitButton.classList.remove("hidden");
        }
      }

      async function handleExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        loader.style.display = "flex";
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];

            // Chuyển sheet sang mảng đối tượng
            const jsonArray = XLSX.utils.sheet_to_json(worksheet);

            // Xử lý jsonArray để tạo danh sách tên nguồn (initialData)
            const newInitialData = jsonArray
              .map((row) => {
                // Cố gắng tìm cột tên. Giả định tên cột có thể là 'Họ và tên', 'Tên', hoặc tương tự
                const fullName =
                  row["Họ và tên"] ||
                  row["Name"] ||
                  row["Tên"] ||
                  row[
                    Object.keys(row).find((key) =>
                      key.toLowerCase().includes("tên")
                    )
                  ];

                if (
                  fullName &&
                  typeof fullName === "string" &&
                  fullName.trim()
                ) {
                  return { name: fullName.trim() };
                }
                return null;
              })
              .filter((item) => item !== null);

            if (newInitialData.length > 0) {
              // *** THAY ĐỔI QUAN TRỌNG: LƯU DANH SÁCH TÊN VÀO RTDB ***
              const appId =
                typeof __app_id !== "undefined" ? __app_id : "default-app-id";
              // Path mới để lưu danh sách tên nguồn
              const sourceNamesPath = `/artifacts/${appId}/public/data/source_names`;
              const namesRef = ref(db, sourceNamesPath);

              // Ghi đè danh sách tên mới vào Database
              await set(namesRef, newInitialData);
              // LƯU Ý: Không cần gán initialData = newInitialData;
              // vì hàm onValue (trong fetchSourceNames) sẽ tự động lắng nghe và cập nhật initialData + UI.

              excelWarning.classList.add("hidden");
              showToast(
                `Đã tải lên và lưu thành công ${newInitialData.length} tên từ file Excel!`
              );
            } else {
              showToast(
                "Không tìm thấy cột 'Họ và tên' hoặc danh sách tên rỗng. Vui lòng kiểm tra lại cấu trúc file Excel.",
                true
              );
              // Nếu không có dữ liệu hợp lệ, xóa dữ liệu cũ (nếu có)
              const appId =
                typeof __app_id !== "undefined" ? __app_id : "default-app-id";
              const sourceNamesPath = `/artifacts/${appId}/public/data/source_names`;
              const namesRef = ref(db, sourceNamesPath);
              await set(namesRef, null); // Xóa danh sách tên trong DB
              excelWarning.classList.remove("hidden");
            }
          } catch (error) {
            console.error("Lỗi khi xử lý file Excel:", error);
            showToast("Lỗi khi xử lý file Excel. Vui lòng thử lại.", true);
          } finally {
            loader.style.display = "none";
            // Clear input để có thể tải lại cùng một file
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function handleDownloadExcel() {
        // Tạo bảng dữ liệu Tải xuống từ combinedData
        const header = [
          "STT",
          "Họ và tên",
          "Số áo",
          "Tên áo",
          "Size áo",
          "Ghi chú",
        ];

        const combinedData = [...initialData].map((person) => {
          const safeKey = person.name.replace(/[.#$/[\]]/g, "_");
          const userData = usersData[safeKey];

          // Xử lý thông tin đăng ký để export
          const shirtNumber = userData?.noShirt
            ? "Không đặt"
            : userData?.shirtNumber || "";
          const shirtName = userData?.noShirt ? "" : userData?.shirtName || "";
          const shirtSize = userData?.noShirt ? "" : userData?.shirtSize || "";
          const note = userData?.noShirt
            ? "Không cần áo"
            : userData
            ? "Đã đăng ký"
            : "Chưa đăng ký";

          return [person.name, shirtNumber, shirtName, shirtSize, note];
        });

        const dataForExport = [
          header,
          ...combinedData.map((data, index) => [index + 1, ...data]),
        ];

        const ws = XLSX.utils.aoa_to_sheet(dataForExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Du_lieu_dang_ky");
        XLSX.writeFile(wb, "Du_lieu_dang_ky_ao.xlsx");
        showToast("Đã tải xuống file Excel!");
      }

      function handleFormSubmit(event) {
        event.preventDefault();
        const selectedName = fullNameSelect.value;
        const shirtNumber =
          shirtNumberInput.value.trim().replace(/^0+/, "") || null;
        const shirtSize = shirtSizeSelect.value || null;
        const noShirt = noNeedShirtCheckbox.checked;
        const shirtName = shirtNameInput.value.trim() || null;

        if (!selectedName) {
          showToast("Vui lòng chọn tên của bạn.", true);
          return;
        }

        if (!noShirt) {
          // Bắt buộc phải điền ít nhất một trong 3 trường nếu không chọn 'Không đặt áo'
          if (!shirtNumber && !shirtName && !shirtSize) {
            showToast("Vui lòng nhập Số áo, Tên áo, hoặc Size áo.", true);
            return;
          }

          // BẮT BUỘC CHỌN SIZE NẾU CÓ ĐẶT ÁO
          if (!shirtSize) {
            showToast("Vui lòng chọn Size áo.", true);
            return;
          }

          // Kiểm tra Số áo chỉ là số (đã được lọc trong event listener, nhưng kiểm tra lại)
          if (shirtNumber && !/^\d+$/.test(shirtNumber)) {
            showToast("Số áo phải là số.", true);
            return;
          }
        }

        // Xác định xem đây là tạo mới hay cập nhật
        const safeKey = selectedName.replace(/[.#$/[\]]/g, "_");
        const isUpdate = !!usersData[safeKey];

        if (isUpdate) {
          submitFormWithDuplicateCheck(false, true); // Là update
        } else {
          submitFormWithDuplicateCheck(false, false); // Là tạo mới
        }
      }

      async function submitFormWithDuplicateCheck(
        forceSubmit,
        isUpdate = false
      ) {
        const selectedName = fullNameSelect.value;
        const shirtNumber =
          shirtNumberInput.value.trim().replace(/^0+/, "") || null;
        const shirtName = shirtNameInput.value.trim() || null;
        const shirtSize = shirtSizeSelect.value || null;
        const noShirt = noNeedShirtCheckbox.checked;

        if (!noShirt && shirtNumber) {
          const userDataArray = Object.values(usersData).map((data) => data);
          // Kiểm tra trùng số áo, bỏ qua người đang chỉnh sửa
          const existingUser = userDataArray.find(
            (user) =>
              user.shirtNumber === shirtNumber && user.fullName !== selectedName
          );

          if (existingUser && !forceSubmit) {
            duplicateModal.classList.remove("hidden");
            return;
          }
        }

        loader.style.display = "flex";

        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        // Tạo key an toàn cho RTDB
        const safeKey = selectedName.replace(/[.#$/[\]]/g, "_");
        const rtdbPath = `/artifacts/${appId}/public/data/registrations/${safeKey}`;
        const userRef = ref(db, rtdbPath);

        const dataToSave = {
          fullName: selectedName,
          // Nếu không đặt áo, lưu các trường kia là null
          shirtNumber: noShirt ? null : shirtNumber || null,
          shirtName: noShirt ? null : shirtName || null,
          shirtSize: noShirt ? null : shirtSize || null,
          noShirt: noShirt,
          // BỎ TRƯỜNG imageUrl
        };

        try {
          if (isUpdate) {
            // Dùng update để chỉ cập nhật các trường có sẵn (cũng có thể dùng set)
            await update(userRef, dataToSave);
            showToast("Thông tin đã được cập nhật thành công!");
          } else {
            // Dùng set để ghi/ghi đè toàn bộ dữ liệu tại nút đó
            await set(userRef, dataToSave);
            showToast("Thông tin đã được lưu thành công!");
          }
        } catch (error) {
          console.error("Lỗi khi lưu dữ liệu vào RTDB:", error);
          showToast("Đã xảy ra lỗi khi lưu dữ liệu.", true);
        } finally {
          loader.style.display = "none";
          updateFormForUser(); // Cập nhật lại trạng thái form sau khi lưu
        }
      }

      // Xóa logic fetchInitialData cũ, chỉ giữ lại hàm initializeAppAndAuth
      initializeAppAndAuth();
    </script>

    <!-- ĐÃ BỎ THẺ <pre> vì dữ liệu nguồn là từ Excel -->
  </body>
</html>
