<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tạo Link Áo & Đăng Ký - Admin/Người Dùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện XLSX để xử lý file Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
      }
      .select2-container--default .select2-selection--single {
        border-radius: 0.5rem;
        height: 42px;
        display: flex;
        align-items: center;
        border: 1px solid #d1d5db;
        padding-left: 0.5rem;
      }
      .select2-container--default
        .select2-selection--single
        .select2-selection__rendered {
        color: #1f2937;
        line-height: 40px;
      }
      .select2-container--default
        .select2-selection--single
        .select2-selection__arrow {
        height: 40px;
      }
      .table-container {
        max-height: 500px;
        overflow-y: auto;
      }
      .shadow-custom {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .tab-button {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        font-weight: 500;
        color: #6b7280;
      }
      .tab-button.active {
        border-color: #4f46e5;
        color: #4f46e5;
        font-weight: 600;
      }
      /* Căn giữa hình ảnh trong giao diện người dùng */
      .img-container {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        border-radius: 0.75rem;
        background-color: #e5e7eb;
        aspect-ratio: 1 / 1;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container mx-auto p-4 sm:p-8" id="app-container">
      <!-- Khung Loading Ban Đầu -->
      <div
        id="loading-panel"
        class="flex justify-center items-center min-h-screen"
      >
        <div class="flex items-center text-indigo-600 font-semibold text-lg">
          <div class="loader" style="display: block"></div>
          Đang kết nối dữ liệu...
        </div>
      </div>

      <!-- Admin Dashboard Panel -->
      <div id="admin-dashboard" class="hidden">
        <div class="flex justify-between items-center mb-6 border-b pb-2">
          <h1 class="text-3xl font-bold text-gray-800">
            Bảng Điều Khiển Admin Cá Nhân
          </h1>
          <p class="text-xs text-gray-500">
            User ID:
            <span id="admin-user-id" class="font-mono text-indigo-600"
              >Loading...</span
            >
          </p>
        </div>

        <div class="flex border-b border-gray-200 mb-6">
          <button
            class="tab-button"
            onclick="switchAdminTab('manage')"
            id="admin-tab-manage"
          >
            Quản Lý Link Đã Tạo
          </button>
          <button
            class="tab-button"
            onclick="switchAdminTab('create')"
            id="admin-tab-create"
          >
            Tạo Link Mới
          </button>
        </div>

        <!-- Tab: Quản Lý Link Đã Tạo -->
        <div id="admin-tab-content-manage" class="hidden">
          <div class="bg-white p-6 rounded-xl shadow-custom">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">
              Danh Sách Các Link Đăng Ký (Riêng tư)
            </h2>
            <div class="table-container">
              <table
                class="min-w-full divide-y divide-gray-200"
                id="link-management-table"
              >
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th
                      class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4"
                    >
                      Tên Link
                    </th>
                    <th
                      class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ID & Ngày tạo
                    </th>
                    <th
                      class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Tên (SL)
                    </th>
                    <th
                      class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5"
                    >
                      Thao tác
                    </th>
                  </tr>
                </thead>
                <tbody
                  class="bg-white divide-y divide-gray-200"
                  id="link-management-body"
                >
                  <!-- Nội dung sẽ được render bằng JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tab: Tạo Link Mới -->
        <div id="admin-tab-content-create" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Cột nhập liệu -->
            <div>
              <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">
                  1. Cấu Hình Link
                </h2>

                <div class="mb-5">
                  <label
                    for="link-name"
                    class="block text-sm font-medium text-gray-700 mb-2"
                    >Tên Link Đăng Ký (Ví dụ: Áo Lớp 2024)</label
                  >
                  <input
                    type="text"
                    id="link-name"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Nhập tên chiến dịch..."
                    required
                  />
                </div>

                <!-- Upload Ảnh Áo -->
                <div class="mb-5">
                  <label
                    for="image-input"
                    class="block text-sm font-medium text-gray-700 mb-2"
                    >Ảnh Áo</label
                  >
                  <input
                    type="file"
                    id="image-input"
                    accept="image/*"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150"
                  />
                  <p id="image-status" class="mt-2 text-sm text-gray-500">
                    Chưa có ảnh được chọn.
                  </p>
                </div>

                <!-- Upload File Excel -->
                <div class="mb-5">
                  <label
                    for="excel-input"
                    class="block text-sm font-medium text-gray-700 mb-2"
                    >File Excel Danh Sách Tên (Phải có cột "Họ và Tên")</label
                  >
                  <input
                    type="file"
                    id="excel-input"
                    accept=".xlsx, .xls"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition duration-150"
                  />
                  <p id="excel-status" class="mt-2 text-sm text-gray-500">
                    Chưa có file Excel được tải lên.
                  </p>
                </div>

                <!-- Nút Tạo Link -->
                <button
                  id="generate-link-btn"
                  class="w-full bg-indigo-600 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-indigo-700 transition duration-200 disabled:opacity-50 flex items-center justify-center"
                  onclick="generateLink()"
                  disabled
                >
                  <div id="generate-loader" class="loader"></div>
                  <span>Tạo Link Đăng Ký Mới</span>
                </button>
              </div>
            </div>

            <!-- Cột xem trước -->
            <div class="hidden md:block">
              <div class="bg-white p-6 rounded-xl shadow-custom sticky top-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                  Xem Trước Ảnh Áo
                </h2>
                <div
                  class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center border-dashed border-2 border-gray-300 overflow-hidden"
                >
                  <img
                    id="preview-image"
                    src="https://placehold.co/400x400/e0e7ff/4338ca?text=Ch%E1%BB%8Dn+%E1%BA%A3nh+%C3%A1o"
                    onerror="this.src='https://placehold.co/400x400/e0e7ff/4338ca?text=Ch%E1%BB%8Dn+%E1%BA%A3nh+%C3%A1o'"
                    alt="Xem trước ảnh áo"
                    class="w-full h-full object-cover"
                  />
                </div>
                <p
                  id="name-count"
                  class="text-center mt-3 text-sm font-medium text-gray-600"
                >
                  Chờ tải file Excel...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- User Registration Panel -->
      <div id="registration-panel" class="hidden">
        <div class="text-center mb-6">
          <h1
            class="text-4xl font-extrabold text-gray-900"
            id="registration-title"
          >
            Đăng Ký Áo
          </h1>
          <p class="text-lg text-gray-500 mt-2" id="registration-subtitle">
            Vui lòng chọn tên và nhập thông tin áo của bạn.
          </p>
        </div>

        <div class="flex border-b border-gray-200 mb-6">
          <button
            class="tab-button"
            onclick="switchUserTab('form')"
            id="user-tab-form"
          >
            Đăng Ký Thông Tin
          </button>
          <button
            class="tab-button"
            onclick="switchUserTab('table')"
            id="user-tab-table"
          >
            Xem Bảng Đăng Ký
          </button>
        </div>

        <div id="user-content-form">
          <div class="max-w-xl mx-auto">
            <div>
              <div class="bg-white p-6 rounded-xl shadow-custom">
                <div class="mb-6 img-container">
                  <img
                    id="shared-image"
                    src="https://placehold.co/300x300/e0e7ff/4338ca?text=Loading..."
                    alt="Ảnh áo"
                    class="w-full h-full object-contain rounded-lg transition-transform duration-300 hover:scale-[1.02]"
                  />
                </div>

                <h2
                  class="text-2xl font-semibold mb-4 text-indigo-600 border-t pt-4"
                >
                  Thông Tin Đăng Ký
                </h2>

                <form id="registration-form">
                  <div class="mb-4">
                    <label
                      for="full-name"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >Họ và Tên</label
                    >
                    <select
                      id="full-name"
                      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500"
                      required
                    ></select>
                  </div>

                  <div class="mb-4 flex items-center">
                    <input
                      type="checkbox"
                      id="no-shirt"
                      class="h-4 w-4 text-red-600 border-gray-300 rounded"
                      onchange="toggleShirtFields(this.checked)"
                    />
                    <label
                      for="no-shirt"
                      class="ml-2 block text-sm font-medium text-gray-900"
                      >Tôi không đặt áo</label
                    >
                  </div>

                  <div id="shirt-fields" class="space-y-4 border-t pt-4">
                    <div class="mb-4">
                      <label
                        for="shirt-number"
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Số Áo</label
                      >
                      <input
                        type="text"
                        inputmode="numeric"
                        pattern="[0-9]*"
                        id="shirt-number"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="999"
                      />
                    </div>

                    <div class="mb-4">
                      <label
                        for="shirt-name"
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Tên Áo</label
                      >
                      <input
                        type="text"
                        id="shirt-name"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="Skibidi"
                      />
                    </div>

                    <div class="mb-4">
                      <label
                        for="shirt-size"
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Size</label
                      >
                      <select
                        id="shirt-size"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                      >
                        <option value="">Chọn size</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="2XL">2XL</option>
                        <option value="3XL">3XL</option>
                      </select>
                    </div>
                  </div>

                  <button
                    type="submit"
                    class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-200 mt-4 disabled:opacity-50 flex items-center justify-center"
                    id="submit-reg-btn"
                  >
                    <div id="reg-loader" class="loader"></div>
                    <span>Lưu Thông Tin</span>
                  </button>
                  <div
                    id="user-status-message"
                    class="mt-3 text-center text-sm font-medium text-green-600"
                  ></div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div id="user-content-table" class="hidden">
          <div class="flex items-center space-x-2 mb-4">
            <span class="font-medium text-gray-700 mr-2">Bộ lọc:</span>
            <button
              onclick="filterTable('all')"
              id="filter-btn-all"
              class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold transition duration-200 text-sm"
            >
              Tất cả
            </button>
            <button
              onclick="filterTable('registered')"
              id="filter-btn-registered"
              class="bg-white text-gray-700 border border-gray-300 py-2 px-4 rounded-lg font-semibold hover:bg-gray-50 transition duration-200 text-sm"
            >
              Đã Đặt/Không Đặt
            </button>
            <button
              onclick="filterTable('unregistered')"
              id="filter-btn-unregistered"
              class="bg-white text-gray-700 border border-gray-300 py-2 px-4 rounded-lg font-semibold hover:bg-gray-50 transition duration-200 text-sm"
            >
              Chưa Đăng Ký
            </button>
            <button
              onclick="exportToExcel()"
              class="bg-emerald-600 text-white py-2.5 px-4 rounded-xl font-semibold hover:bg-emerald-700 transition duration-200 ml-auto text-sm"
            >
              Tải Xuống File Excel
            </button>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-custom table-container">
            <table
              class="min-w-full divide-y divide-gray-200"
              id="excel-export-table"
            >
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    STT
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Họ và Tên
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Số Áo
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Tên In Áo
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Cỡ Áo
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Trạng Thái
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Thời gian ĐK
                  </th>
                </tr>
              </thead>
              <tbody
                class="bg-white divide-y divide-gray-200"
                id="excel-export-body"
              >
                <!-- Dữ liệu được render tại đây -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification / Modal -->
    <div
      id="toast"
      class="fixed bottom-5 right-5 z-50 p-4 rounded-xl text-white font-medium transition-opacity duration-300 opacity-0"
      style="min-width: 200px"
    ></div>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        update,
        remove,
        onValue,
        off,
        get,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
      // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

      // Global variables for Firebase
      let db;
      let auth;
      let userId;
      let appId;
      let currentConfig = null;
      let currentId = null; // ID của link đang xem

      // --- CẤU HÌNH CLOUDINARY (CẦN THAY THẾ) ---
      const CLOUDINARY_CLOUD_NAME = "dys3wgutz";
      const CLOUDINARY_UPLOAD_PRESET = "comic_images_preset";

      // --- HÀM TIỆN ÍCH CHUNG ---

      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `fixed bottom-5 right-5 z-50 p-4 rounded-xl text-white font-medium transition-opacity duration-300 shadow-lg ${
          isError ? "bg-red-500" : "bg-blue-600"
        }`;
        toast.classList.add("opacity-100");

        setTimeout(() => {
          toast.classList.remove("opacity-100");
          toast.classList.add("opacity-0");
        }, 3000);
      }

      function getBaseUrl() {
        return window.location.origin + window.location.pathname;
      }

      function formatTimestamp(timestamp) {
        if (!timestamp) return "N/A";
        const date = new Date(timestamp);
        return (
          date.toLocaleDateString("vi-VN") +
          " " +
          date.toLocaleTimeString("vi-VN").substring(0, 5)
        );
      }

      /**
       * Chuyển tên đầy đủ (full name) thành key an toàn cho RTDB.
       * RTDB không cho phép các ký tự: ., $, #, [, ], /.
       */
      function safeKey(name) {
        return name
          .trim()
          .toLowerCase()
          .replace(/[.#$/[\]]/g, "_");
      }

      /**
       * Hàm đọc file Excel, tìm và đọc cột có tiêu đề "Họ và Tên".
       */
      function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];

              // Đọc dữ liệu từ sheet
              const json = XLSX.utils.sheet_to_json(worksheet, {
                header: 1, // Lấy header
                defval: "",
              });

              if (json.length === 0) return resolve([]);

              // Hàng đầu tiên chứa tiêu đề
              const headers = json[0].map((h) => String(h).trim());
              const nameColumnIndex = headers.findIndex(
                (h) => h === "Họ và tên"
              );

              if (nameColumnIndex === -1) {
                return reject(
                  "Không tìm thấy cột có tiêu đề 'Họ và tên' trong file Excel."
                );
              }

              // Lọc lấy tên từ cột "Họ và tên" (bắt đầu từ hàng thứ 2)
              const names = json
                .slice(1)
                .map((row) => String(row[nameColumnIndex] || "").trim())
                .filter((name) => name);

              resolve(names);
            } catch (error) {
              console.error("Lỗi Excel:", error);
              reject("Lỗi khi đọc file Excel. Vui lòng kiểm tra định dạng.");
            }
          };
          reader.onerror = (e) => reject("Lỗi đọc file.");
          reader.readAsArrayBuffer(file);
        });
      }

      // --- FIREBASE INIT VÀ AUTH ---

      async function initFirebase() {
        try {
          appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
          const firebaseConfig = {
            apiKey: "AIzaSyCvC6yMxGShDbe6CFxW_BJr4jWshZ0WFAU",
            authDomain: "webchonao.firebaseapp.com",
            databaseURL: "https://webchonao-default-rtdb.firebaseio.com",
            projectId: "webchonao",
            storageBucket: "webchonao.firebasestorage.app",
            messagingSenderId: "1003558568709",
            appId: "1:1003558568709:web:054e30c22b0349dfb56d6c",
            measurementId: "G-F7ZL70RDE9",
          };

          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getDatabase(app);

          // setLogLevel('debug'); // Bật log cho RTDB

          // Đăng nhập/Xác thực người dùng
          const initialAuthToken =
            typeof __initial_auth_token !== "undefined"
              ? __initial_auth_token
              : null;

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth); // Mọi người dùng vào link main đều có 1 admin riêng
          }

          userId = auth.currentUser?.uid || "anonymous-user";
          document.getElementById("admin-user-id").textContent = userId;

          routeApp();
        } catch (error) {
          console.error("Lỗi khởi tạo Firebase:", error);
          showToast("Lỗi khởi tạo ứng dụng. Vui lòng kiểm tra console.", true);
          document.getElementById(
            "loading-panel"
          ).innerHTML = `<div class="p-8 text-center bg-white rounded-xl shadow-custom mt-12"><h1 class="text-3xl font-bold text-red-600">Lỗi Kết Nối Dữ Liệu</h1><p class="mt-2 text-gray-600">Không thể kết nối với Firebase. Vui lòng kiểm tra cấu hình.</p></div>`;
        }
      }

      // --- ADMIN DASHBOARD LOGIC (SỬ DỤNG RTDB) ---

      let adminConfigsListener = null;
      let excelNames = [];

      function getAdminConfigsPath() {
        return `/artifacts/${appId}/users/${userId}/link_configs`;
      }

      window.switchAdminTab = function (tabName) {
        const tabs = ["create", "manage"];
        tabs.forEach((tab) => {
          document
            .getElementById(`admin-tab-content-${tab}`)
            .classList.add("hidden");
          document
            .getElementById(`admin-tab-${tab}`)
            .classList.remove("active");
        });

        document
          .getElementById(`admin-tab-content-${tabName}`)
          .classList.remove("hidden");
        document.getElementById(`admin-tab-${tabName}`).classList.add("active");

        if (tabName === "manage") {
          setupAdminConfigsListener();
        } else {
          if (adminConfigsListener) {
            adminConfigsListener(); // Tắt lắng nghe
            adminConfigsListener = null; // Đặt lại về null
          }
        }
      };

      /**
       * Lắng nghe và hiển thị danh sách cấu hình link của Admin.
       */
      function setupAdminConfigsListener() {
        // Ngừng lắng nghe cũ nếu có
        if (adminConfigsListener) {
          adminConfigsListener();
          adminConfigsListener = null;
        }

        const configsRef = ref(db, getAdminConfigsPath());

        adminConfigsListener = onValue(
          configsRef,
          (snapshot) => {
            const configsData = snapshot.val() || {};
            const configsArray = Object.values(configsData).sort(
              (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
            );
            renderAdminDashboard(configsArray);
          },
          (error) => {
            console.error("Lỗi đọc cấu hình admin:", error);
            showToast("Không thể tải danh sách link.", true);
          }
        );
      }

      /**
       * Render bảng điều khiển quản lý link.
       */
      function renderAdminDashboard(configs) {
        const tableBody = document.getElementById("link-management-body");
        tableBody.innerHTML = "";
        const baseUrl = getBaseUrl();

        if (configs.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Chưa có link nào được tạo.</td></tr>`;
          return;
        }

        configs.forEach((config) => {
          const shareLink = `${baseUrl}?id=${config.id}`;

          // Lấy số lượng đăng ký thực tế (chỉ lấy 1 lần, không real-time để tránh phí tài nguyên)
          get(ref(db, getRegistrationPath(config.id))).then((snapshot) => {
            const registrations = snapshot.val() || {};
            const registrationCount = Object.keys(registrations).length;

            const row = tableBody.querySelector(`#row-${config.id}`);
            if (row) {
              row.querySelector(
                ".reg-count"
              ).textContent = `${config.names.length} (${registrationCount} Đã ĐK)`;
            }
          });

          const row = tableBody.insertRow();
          row.id = `row-${config.id}`;
          row.className = "hover:bg-gray-50 transition duration-100";
          row.innerHTML = `
                    <td class="px-3 py-3 text-sm font-semibold text-indigo-600">${
                      config.name
                    }</td>
                    <td class="px-3 py-3 text-sm text-gray-500">
                        <span class="font-mono text-xs block">${config.id.substring(
                          0,
                          8
                        )}...</span>
                        <span class="text-xs text-gray-400">${formatTimestamp(
                          config.timestamp
                        )}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-gray-500 reg-count">Đang tải...</td>
                    <td class="px-3 py-3 text-sm space-y-2">
                        <div class="flex gap-2">
                            <button onclick="copyLink('${shareLink}')" class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-green-600 transition duration-150">
                                Copy Link
                            </button>
                            <button onclick="window.open('${shareLink}', '_blank')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-600 transition duration-150">
                                Xem Form
                            </button>
                            <button onclick="window.open('${shareLink}&tab=table', '_blank')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-600 transition duration-150">
                                Xem Bảng
                            </button>
                        </div>
                        <button onclick="deleteLinkConfig('${
                          config.id
                        }')" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg text-xs hover:bg-gray-400 transition duration-150 mt-1">
                            Xóa Cấu Hình & Dữ Liệu
                        </button>
                    </td>
                `;
        });
      }

      window.deleteLinkConfig = async function (id) {
        if (
          !window.confirm(
            "Bạn có chắc chắn muốn XÓA cấu hình link này và TẤT CẢ dữ liệu đăng ký kèm theo không? Hành động này không thể hoàn tác!"
          )
        ) {
          return;
        }

        try {
          // 1. Xóa cấu hình khỏi tài khoản Admin
          await remove(ref(db, `${getAdminConfigsPath()}/${id}`));

          // 2. Xóa tất cả dữ liệu đăng ký công khai
          await remove(ref(db, getRegistrationPath(id)));

          showToast("Đã xóa thành công cấu hình và dữ liệu liên quan.");
        } catch (error) {
          console.error("Lỗi khi xóa link:", error);
          showToast("Lỗi khi xóa dữ liệu. Vui lòng thử lại.", true);
        }
      };

      // Upload ảnh và tạo link
      document
        .getElementById("excel-input")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) {
            excelNames = [];
            document.getElementById("excel-status").textContent =
              "Chưa có file Excel được tải lên.";
            document.getElementById("name-count").textContent =
              "Chờ tải file Excel...";
            checkAdminReadiness();
            return;
          }

          try {
            excelNames = await readExcelFile(file);
            document.getElementById(
              "excel-status"
            ).textContent = `Đã tải: ${file.name} (${excelNames.length} tên)`;
            document.getElementById(
              "name-count"
            ).textContent = `Danh sách đã tải: ${excelNames.length} tên.`;
            checkAdminReadiness();
          } catch (error) {
            showToast(error, true);
            excelNames = [];
            document.getElementById(
              "excel-status"
            ).textContent = `Lỗi: ${error}`;
            document.getElementById("name-count").textContent =
              "Lỗi khi tải file Excel.";
            checkAdminReadiness();
          }
        });

      document.getElementById("image-input").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const localUrl = URL.createObjectURL(file);
          document.getElementById("preview-image").src = localUrl;
          document.getElementById(
            "image-status"
          ).textContent = `Đã chọn: ${file.name}`;
        } else {
          document.getElementById("preview-image").src =
            "https://placehold.co/400x400/e0e7ff/4338ca?text=Ch%E1%BB%8Dn+%E1%BA%A3nh+%C3%A1o";
          document.getElementById("image-status").textContent =
            "Chưa có ảnh được chọn.";
        }
        checkAdminReadiness();
      });

      async function uploadImage(file) {
        if (
          CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME" ||
          CLOUDINARY_UPLOAD_PRESET === "YOUR_UPLOAD_PRESET"
        ) {
          showToast(
            "Sử dụng ảnh demo, ảnh sẽ bị mất khi đóng trang nếu không cấu hình Cloudinary!",
            true
          );
          return new Promise((resolve) => {
            const localUrl = URL.createObjectURL(file);
            resolve(localUrl);
          });
        }

        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        try {
          const response = await fetch(url, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            throw new Error(`Cloudinary upload failed: ${response.statusText}`);
          }
          const result = await response.json();
          return result.secure_url;
        } catch (error) {
          console.error("Lỗi Cloudinary:", error);
          throw new Error("Lỗi khi tải ảnh lên Cloudinary.");
        }
      }

      function checkAdminReadiness() {
        const imageFile = document.getElementById("image-input").files[0];
        const excelFile = document.getElementById("excel-input").files[0];
        const linkName = document.getElementById("link-name").value.trim();
        const isReady =
          imageFile &&
          excelFile &&
          excelNames.length > 0 &&
          linkName.length > 0;
        document.getElementById("generate-link-btn").disabled = !isReady;
        return isReady;
      }

      window.generateLink = async function () {
        if (!checkAdminReadiness()) {
          showToast(
            "Vui lòng điền đủ Tên link, Ảnh và File Excel hợp lệ.",
            true
          );
          return;
        }

        const imageFile = document.getElementById("image-input").files[0];
        const linkName = document.getElementById("link-name").value.trim();

        const generateBtn = document.getElementById("generate-link-btn");
        const loader = document.getElementById("generate-loader");

        generateBtn.disabled = true;
        loader.style.display = "block";

        try {
          // 1. Upload ảnh
          document.querySelector("#generate-link-btn span").textContent =
            "Đang tải ảnh lên...";
          const uploadedImageUrl = await uploadImage(imageFile);

          // 2. Tạo ID duy nhất và lưu cấu hình vào RTDB
          document.querySelector("#generate-link-btn span").textContent =
            "Đang lưu cấu hình...";
          const uniqueId = crypto.randomUUID();
          const config = {
            id: uniqueId,
            name: linkName,
            imageUrl: uploadedImageUrl,
            names: excelNames,
            timestamp: new Date().toISOString(),
            creatorId: userId,
          };

          const configRef = ref(db, `${getAdminConfigsPath()}/${uniqueId}`);
          await set(configRef, config);

          // 3. Hiển thị thông báo và chuyển tab
          showToast(`Đã tạo link "${linkName}" thành công!`);

          // Reset form tạo link
          document.getElementById("link-name").value = "";
          document.getElementById("image-input").value = "";
          document.getElementById("excel-input").value = "";
          document.getElementById("preview-image").src =
            "https://placehold.co/400x400/e0e7ff/4338ca?text=Ch%E1%BB%8Dn+%E1%BA%A3nh+%C3%A1o";
          document.getElementById("image-status").textContent =
            "Chưa có ảnh được chọn.";
          document.getElementById("excel-status").textContent =
            "Chưa có file Excel được tải lên.";
          excelNames = [];

          switchAdminTab("manage"); // Chuyển sang tab quản lý
        } catch (error) {
          showToast(error.message || "Lỗi không xác định khi tạo link.", true);
        } finally {
          document.querySelector("#generate-link-btn span").textContent =
            "Tạo Link Đăng Ký Mới";
          loader.style.display = "none";
          checkAdminReadiness();
        }
      };

      window.copyLink = function (link) {
        if (navigator.clipboard) {
          navigator.clipboard
            .writeText(link)
            .then(() => {
              showToast("Đã sao chép link!");
            })
            .catch((err) => {
              fallbackCopyTextToClipboard(link);
            });
        } else {
          fallbackCopyTextToClipboard(link);
        }
      };

      function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand("copy");
          showToast("Đã sao chép link (Fallback)!");
        } catch (err) {
          showToast("Không thể sao chép, vui lòng copy thủ công.", true);
        }
        document.body.removeChild(textArea);
      }

      // --- USER REGISTRATION LOGIC (SỬ DỤNG RTDB) ---

      let registrationsListener = null;
      let currentRegistrations = {};
      let currentFilter = "all"; // Trạng thái bộ lọc mặc định

      function getRegistrationPath(id) {
        return `/artifacts/${appId}/public/data/registrations/${id}`;
      }

      window.toggleShirtFields = function (noShirtChecked) {
        const shirtFields = document.getElementById("shirt-fields");
        const submitBtn = document.getElementById("submit-reg-btn");
        if (noShirtChecked) {
          shirtFields.classList.add("hidden");
          submitBtn.querySelector("span").textContent = "Xác nhận KHÔNG đặt áo";
        } else {
          shirtFields.classList.remove("hidden");
          submitBtn.querySelector("span").textContent = "Lưu Thông Tin";
        }
      };

      window.switchUserTab = function (tabName) {
        const formTab = document.getElementById("user-tab-form");
        const tableTab = document.getElementById("user-tab-table");
        const formContent = document.getElementById("user-content-form");
        const tableContent = document.getElementById("user-content-table");

        formTab.classList.remove("active");
        tableTab.classList.remove("active");
        formContent.classList.add("hidden");
        tableContent.classList.add("hidden");

        if (tabName === "form") {
          formTab.classList.add("active");
          formContent.classList.remove("hidden");
        } else {
          tableTab.classList.add("active");
          tableContent.classList.remove("hidden");
          // Đồng bộ dữ liệu và đặt bộ lọc mặc định là "tất cả"
          filterTable("all");
        }
      };

      window.filterTable = function (filter) {
        currentFilter = filter;
        // Cập nhật giao diện nút
        const buttons = ["all", "registered", "unregistered"];
        buttons.forEach((btn) => {
          const el = document.getElementById(`filter-btn-${btn}`);
          if (btn === filter) {
            el.classList.remove(
              "bg-white",
              "text-gray-700",
              "border",
              "border-gray-300",
              "hover:bg-gray-50"
            );
            el.classList.add("bg-indigo-600", "text-white");
          } else {
            el.classList.remove("bg-indigo-600", "text-white");
            el.classList.add(
              "bg-white",
              "text-gray-700",
              "border",
              "border-gray-300",
              "hover:bg-gray-50"
            );
          }
        });
        renderExportTable();
      };

      /**
       * Lắng nghe RTDB để cập nhật bảng đăng ký theo thời gian thực.
       */
      function setupRegistrationsListener(id) {
        if (registrationsListener) {
          off(registrationsListener);
        }

        const regsRef = ref(db, getRegistrationPath(id));

        registrationsListener = onValue(
          regsRef,
          (snapshot) => {
            currentRegistrations = snapshot.val() || {};

            // Cập nhật form người dùng hiện tại (nếu đang chọn tên)
            const selectedName = $("#full-name").val();
            if (selectedName) {
              updateFormForUser(selectedName);
            }

            // Nếu người dùng đang xem tab bảng, cập nhật luôn
            if (
              !document
                .getElementById("user-content-table")
                .classList.contains("hidden")
            ) {
              renderExportTable();
            }
          },
          (error) => {
            console.error("Lỗi đọc dữ liệu đăng ký:", error);
            showToast("Không thể tải bảng đăng ký.", true);
          }
        );
      }

      /**
       * Render bảng lớn (Table View) với bộ lọc
       */
      function renderExportTable() {
        const tableBody = document.getElementById("excel-export-body");
        tableBody.innerHTML = "";

        if (
          !currentConfig ||
          !currentConfig.names ||
          currentConfig.names.length === 0
        ) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Không có danh sách tên để hiển thị.</td></tr>`;
          return;
        }

        const allNames = [...currentConfig.names];

        let filteredNames = allNames;
        if (currentFilter === "registered") {
          filteredNames = allNames.filter(
            (name) => currentRegistrations[safeKey(name)]
          );
        } else if (currentFilter === "unregistered") {
          filteredNames = allNames.filter(
            (name) => !currentRegistrations[safeKey(name)]
          );
        }

        if (filteredNames.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Không có dữ liệu phù hợp với bộ lọc.</td></tr>`;
          return;
        }

        filteredNames.forEach((name, index) => {
          const userDataKey = safeKey(name);
          const reg = currentRegistrations[userDataKey];
          const row = tableBody.insertRow();
          row.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";

          let statusText,
            statusClass,
            shirtNumber,
            shirtName,
            shirtSize,
            timestamp;

          if (reg) {
            if (reg.noShirt) {
              statusText = "Không Đặt Áo";
              statusClass = "text-red-600 font-semibold";
              shirtNumber = "-";
              shirtName = "-";
              shirtSize = "-";
            } else {
              statusText = "Đã Đăng Ký";
              statusClass = "text-green-600 font-semibold";
              shirtNumber = reg.shirtNumber || "Chưa nhập";
              shirtName = reg.shirtName || "Chưa nhập";
              shirtSize = reg.shirtSize || "Chưa chọn";
            }
            timestamp = formatTimestamp(reg.timestamp);
          } else {
            statusText = "Chưa Đăng Ký";
            statusClass = "text-gray-500";
            shirtNumber = "-";
            shirtName = "-";
            shirtSize = "-";
            timestamp = "-";
          }

          row.innerHTML = `
            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${
              index + 1
            }</td>
            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${shirtNumber}</td>
            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${shirtName}</td>
            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${shirtSize}</td>
            <td class="px-3 py-2 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
          `;
        });
      }

      /**
       * Xuất dữ liệu bảng hiện tại ra file Excel
       */
      window.exportToExcel = function () {
        const table = document.getElementById("excel-export-table");
        const ws = XLSX.utils.table_to_sheet(table);

        // Tinh chỉnh độ rộng cột
        ws["!cols"] = [
          { wch: 5 }, // STT
          { wch: 25 }, // Họ và Tên
          { wch: 10 }, // Số Áo
          { wch: 15 }, // Tên In Áo
          { wch: 10 }, // Cỡ Áo
          { wch: 15 }, // Trạng Thái
          { wch: 20 }, // Thời gian ĐK
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DanhSachDangKy");

        const linkName = currentConfig.name || "Dang_Ky_Ao";
        XLSX.writeFile(
          wb,
          `${linkName}_${new Date().toLocaleDateString("en-CA")}.xlsx`
        );
        showToast("Đã tải xuống file Excel!");
      };

      function updateFormForUser(selectedName) {
        const userData = currentRegistrations[safeKey(selectedName)];
        const noShirtCheckbox = document.getElementById("no-shirt");

        // Reset các trường
        document.getElementById("shirt-number").value = "";
        document.getElementById("shirt-name").value = "";
        document.getElementById("shirt-size").value = "";
        noShirtCheckbox.checked = false;

        if (userData) {
          // Điền dữ liệu nếu có
          document.getElementById("shirt-number").value =
            userData.shirtNumber || "";
          document.getElementById("shirt-name").value =
            userData.shirtName || "";
          document.getElementById("shirt-size").value =
            userData.shirtSize || "";
          noShirtCheckbox.checked = userData.noShirt;

          document.getElementById(
            "user-status-message"
          ).textContent = `Thông tin của bạn đã được cập nhật lần cuối vào ${formatTimestamp(
            userData.timestamp
          )}.`;
        } else {
          document.getElementById("user-status-message").textContent =
            "Lần đầu đăng ký. Vui lòng nhập thông tin.";
        }

        toggleShirtFields(noShirtCheckbox.checked);
        $("#full-name").val(selectedName).trigger("change.select2");
      }

      async function handleRegistrationSubmit(e) {
        e.preventDefault();

        const selectedName = $("#full-name").val();
        const noShirt = document.getElementById("no-shirt").checked;
        const submitBtn = document.getElementById("submit-reg-btn");
        const loader = document.getElementById("reg-loader");

        if (!selectedName) {
          showToast("Vui lòng chọn Tên của bạn.", true);
          return;
        }

        submitBtn.disabled = true;
        loader.style.display = "block";

        let registrationData = {
          fullName: selectedName,
          noShirt: noShirt,
          timestamp: new Date().toISOString(),
        };

        const userDataKey = safeKey(selectedName);
        const userRef = ref(
          db,
          `${getRegistrationPath(currentId)}/${userDataKey}`
        );

        if (!noShirt) {
          // Cho phép nhập text (bao gồm số 0 ở đầu)
          registrationData.shirtNumber = document
            .getElementById("shirt-number")
            .value.trim();
          registrationData.shirtName = document
            .getElementById("shirt-name")
            .value.trim();

          registrationData.shirtSize =
            document.getElementById("shirt-size").value;

          if (!registrationData.shirtSize) {
            showToast("Vui lòng chọn Cỡ Áo.", true);
            submitBtn.disabled = false;
            loader.style.display = "none";
            return;
          }
        } else {
          // Nếu không đặt áo, set các trường liên quan thành null (RTDB sẽ xóa key)
          registrationData.shirtNumber = null;
          registrationData.shirtName = null;
          registrationData.shirtSize = null;
        }

        try {
          // Dùng set để ghi đè toàn bộ dữ liệu tại node này
          await set(userRef, registrationData);
          showToast("Thông tin đã được lưu thành công!");
          // Lắng nghe RTDB sẽ tự động cập nhật form và bảng
        } catch (error) {
          console.error("Lỗi khi lưu đăng ký:", error);
          showToast("Đã xảy ra lỗi khi lưu dữ liệu.", true);
        } finally {
          submitBtn.disabled = false;
          loader.style.display = "none";
          updateFormForUser(selectedName);
        }
      }

      async function initializeUserPanel(id) {
        currentId = id;

        // 1. Tải cấu hình link (từ bất kỳ Admin nào đã tạo)
        const allConfigsRef = ref(db, `/artifacts/${appId}/users`);
        const allConfigsSnapshot = await get(allConfigsRef);
        let foundConfig = null;

        if (allConfigsSnapshot.exists()) {
          allConfigsSnapshot.forEach((userSnapshot) => {
            const userConfigs = userSnapshot.val().link_configs || {};
            const config = userConfigs[id];
            if (config) {
              foundConfig = config;
              return true; // Dừng forEach
            }
          });
        }

        currentConfig = foundConfig;

        if (!currentConfig) {
          document.getElementById("registration-panel").classList.add("hidden");
          document.getElementById(
            "loading-panel"
          ).innerHTML = `<div class="p-8 text-center bg-white rounded-xl shadow-custom mt-12"><h1 class="text-3xl font-bold text-red-600">Lỗi: Link không hợp lệ hoặc dữ liệu cấu hình đã bị xóa.</h1><p class="mt-2 text-gray-600">Vui lòng liên hệ Admin để kiểm tra lại link.</p></div>`;
          return;
        }

        // 2. Cập nhật tiêu đề và ảnh
        document.getElementById("registration-title").textContent =
          currentConfig.name || "Đăng Ký Áo";
        document.getElementById(
          "registration-subtitle"
        ).textContent = `Link được tạo bởi ID: ${currentConfig.creatorId.substring(
          0,
          8
        )}...`;
        document.getElementById("shared-image").src = currentConfig.imageUrl;
        document.getElementById("shared-image").onerror = function () {
          this.src =
            "https://placehold.co/300x300/e0e7ff/4338ca?text=L%E1%BB%97i+%E1%BA%A2nh";
        };

        // 3. Load danh sách tên vào Select2
        const selectName = $("#full-name");
        selectName.empty();
        selectName.append(
          new Option("--- Chọn Họ và Tên của bạn ---", "", true, true)
        );
        currentConfig.names.forEach((name) => {
          selectName.append(new Option(name, name));
        });
        selectName.select2({
          placeholder: "Chọn tên của bạn từ danh sách",
          allowClear: true,
        });

        // 4. Lắng nghe thay đổi tên (để điền dữ liệu cũ)
        selectName.on("change", function () {
          const selectedName = $(this).val();
          if (selectedName) {
            updateFormForUser(selectedName);
          } else {
            document.getElementById("registration-form").reset();
            toggleShirtFields(false);
            document.getElementById("user-status-message").textContent = "";
          }
        });

        // 5. Lắng nghe form submit
        document
          .getElementById("registration-form")
          .addEventListener("submit", handleRegistrationSubmit);

        // 6. Thiết lập lắng nghe RTDB cho dữ liệu đăng ký
        setupRegistrationsListener(id);

        // 7. Định tuyến đến tab mặc định
        const params = new URLSearchParams(window.location.search);
        const defaultTab = params.get("tab") === "table" ? "table" : "form";
        switchUserTab(defaultTab);
      }

      // --- ROUTING CHÍNH ---

      function routeApp() {
        document.getElementById("loading-panel").classList.add("hidden");
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        if (id) {
          // Người dùng click vào link chia sẻ
          document.getElementById("admin-dashboard").classList.add("hidden");
          document
            .getElementById("registration-panel")
            .classList.remove("hidden");
          initializeUserPanel(id);
        } else {
          // Người dùng vào link gốc (mặc định là Admin Dashboard riêng tư)
          document.getElementById("registration-panel").classList.add("hidden");
          document.getElementById("admin-dashboard").classList.remove("hidden");
          switchAdminTab("manage");
        }
      }

      // Khởi động ứng dụng
      window.onload = initFirebase;
    </script>
  </body>
</html>
